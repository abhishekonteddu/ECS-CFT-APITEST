AWSTemplateFormatVersion: "2010-09-09"
Description: My ECS stack.
Parameters:
  pStage:
    Description: Stage type
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - prod
  pContainerMemory:
    Description: Memory for the fargate Task
    Type: Number
    Default: 2048
  pContainerCpu:
    Description: Cpu for the fargate task
    Type: Number
    Default: 1024
  pVPCID:
    Description: Id of and existing Development VPC
    Type: "AWS::EC2::VPC::Id"
    ConstraintDescription: Must be a valid VPC.
  pSubnetId1:
    Description: "Private subnet for confidential apps "
    Type: "AWS::EC2::Subnet::Id"
    MinLength: "1"
    MaxLength: "255"
    ConstraintDescription: Must be a valid Private Subnet.
  pSubnetId2:
    Description: "Private subnet for confidential apps "
    Type: "AWS::EC2::Subnet::Id"
    MinLength: "1"
    MaxLength: "255"
    ConstraintDescription: Must be a valid Private Subnet.
  pSubnetId3:
    Description: "Private subnet for confidential apps "
    Type: "AWS::EC2::Subnet::Id"
    MinLength: "1"
    MaxLength: "255"
  pCloudWatchLogRetain:
    Description: Cloudwatch logs regain in days
    Type: Number
    Default: 7
    MinValue: 1
    MaxValue: 3653

Metadata:
  # The AWS::CloudFormation::Interface key contains metadata that specifies how AWS CloudFormation presents the
  # parameters and outputs in the AWS Management Console. The key is used to define the parameter grouping and
  # parameter labels for the parameters in this template.
  AWS::CloudFormation::Interface:
    ParameterLabels:
          pStage:
            default: Environment
          pContainerMemory:
            default: Container Memory
          pContainerCpu:
            default: Container CPU
          pVPCID:
            default: VPC ID
          pSubnetId1:
            default: Subnet 1
          pSubnetId2:
            default: Subnet 2
          pSubnetId3:
            default: Subnet 3
          pCloudWatchLogRetain:
            default: cloudwatch logs retain in days  
    ParameterGroups:
      - Label:
          # The default key specifies the label that is displayed for the parameter group in the AWS Management Console.
          default: "Fargate Task Configuration"
        Parameters:
          - pStage:
              Label: "Environment"
          - pContainerMemory:
              Label: "Container Memory"
          - Container CPU:
              Label: "Container CPU"
          - pVPCID:
              Label: "VPC ID"
          - pSubnetId1:
              Label: "Subent 1"
          - pSubnetId2:
              Label: "Subent 2"
          - pSubnetId3:
              Label: "Subent 3"
          - pCloudWatchLogRetain:
              Label: "cloudwatch logs retain in days"
Resources:
  MyServiceECSCluster:
    Type: "AWS::ECS::Cluster"
    Properties:
      ClusterName: !Sub My-service-${pStage}-ecs-cluster
      ClusterSettings:
        - Name: containerInsights
          Value: enabled

  MyServiceECSRole:
    Type: "AWS::IAM::Role"
    Properties:
      RoleName: !Sub My-service-${pStage}-MyServiceECSRole
      
      # PermissionsBoundary: !Sub "arn:aws:iam::${AWS::AccountId}:policy/PermissionBoundary-DevOps"
      
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - "ecs-tasks.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      Policies:
        - PolicyName: !Sub My-service-${pStage}-MyServiceECSPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - ssm:DescribeParameters
                  - ssm:GetParametersByPath
                  - ecs:RunTask
                Resource: "*"
      Path: "/"

  MyServiceECSTaskExecutionRole:
    Type: "AWS::IAM::Role"
    Properties:
      RoleName: !Sub "MyService-${pStage}-Task-ExecutionRole"

      # PermissionsBoundary: !Sub "arn:aws:iam::${AWS::AccountId}:policy/PermissionBoundary-DevOps"
      
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - "ecs-tasks.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      Policies:
        - PolicyName: !Sub My-service-${pStage}-MyServiceTaskExecutionPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - ecr:GetAuthorizationToken
                  - ecr:BatchCheckLayerAvailability
                  - ecr:GetDownloadUrlForLayer
                  - ecr:BatchGetImage
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:CreateLogGroup
                  - logs:DescribeLogGroups
                Resource: "*"
      Path: "/"

  MyServiceCloudWatchEventRole:
    Type: "AWS::IAM::Role"
    Properties:
      RoleName: !Sub "My-${pStage}-Service-CloudWatchEventRole"

      # PermissionsBoundary: !Sub "arn:aws:iam::${AWS::AccountId}:policy/PermissionBoundary-DevOps"
      
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - "events.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      Policies:
        - PolicyName: !Sub My-service-${pStage}-MyServiceECSTaskExecutionPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - ecs:RunTask
                Resource: !Ref MyServiceEcsTaskDefinition
        - PolicyName: !Sub My-service-${pStage}-MyServiceECSTaskExecutionIAMPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - iam:PassRole
                Resource: "*"
      Path: "/"
    DependsOn:
      - MyServiceEcsTaskDefinition

  MyServiceEcsLogsGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub My-service-${pStage}-task-LogsGroup
      RetentionInDays: !Ref pCloudWatchLogRetain

  MyServiceFargateSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: ECS Fargate Security Group
      VpcId: !Ref pVPCID
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0

  MyServiceEcsTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Cpu: !Ref pContainerCpu
      Memory: !Ref pContainerMemory
      ExecutionRoleArn: !GetAtt
        - MyServiceECSTaskExecutionRole
        - Arn
      Family: !Sub My-service-${pStage}-task-definition
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      TaskRoleArn: !GetAtt MyServiceECSRole.Arn
      ContainerDefinitions:
        - Image: !Sub "abhishekonteddu/ecsapitest:latest"
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref MyServiceEcsLogsGroup
              awslogs-region: !Ref "AWS::Region"
              awslogs-stream-prefix: ecs
          Name: !Sub My-service-${pStage}-MyServiceTaskContainer    
          Memory: !Ref pContainerMemory
          Cpu: !Ref pContainerCpu
          PortMappings:
            - { ContainerPort: 80 }

  MyServiceScheduleRule:
    Type: AWS::Events::Rule
    Properties:
      Description: "Schedule rule for My Service"
      Name: !Sub My-service-task-schedule-rule-${pStage}
      State: ENABLED
      ScheduleExpression: cron(0/1 * ? * * *)
      Targets:
        - Arn: !GetAtt MyServiceECSCluster.Arn
          Id: ScheduledTask
          RoleArn: !GetAtt MyServiceCloudWatchEventRole.Arn
          EcsParameters:
            TaskDefinitionArn: !Ref MyServiceEcsTaskDefinition
            LaunchType: FARGATE
            NetworkConfiguration:
              AwsVpcConfiguration:
                AssignPublicIp: ENABLED
                SecurityGroups:
                  - !Ref MyServiceFargateSecurityGroup
                Subnets:
                  - !Ref pSubnetId1
                  - !Ref pSubnetId2
                  - !Ref pSubnetId3
Outputs:
  MyServiceEcsLogsGroup:
    Description: The ID of the log
    Value: !Sub My-service-${pStage}-task-LogsGroup
